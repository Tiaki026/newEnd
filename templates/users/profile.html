{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="profile-container">
    <div class="profile-wrapper">
        <div class="profile-sidebar">
            <div class="profile-card">
                <div class="profile-avatar">
                    <div class="avatar-placeholder">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    {% if user.first_name %}
                    <h3 class="profile-name">{{ user.first_name }}</h3>
                    {% else %}
                    <h3 class="profile-name">{{ user.username }}</h3>
                    {% endif %}
                    <p class="profile-username">@{{ user.username }}</p>
                </div>

                <div class="profile-divider"></div>

                <div class="stat-label characters-count">
                    Персонажей: <span class="count">{{ characters_count|default:"0" }}</span>
                </div>

                <div class="profile-divider"></div>

                <div class="stat-label"><span class="main-badge">Основной</span>
                    <div class="stat-number">
                        {{ main_character_name|default:"Нет" }}<br>
                        {{ main_character_class|default:"Класс" }} -
                        {{ main_specialization_name |default:"Специализация" }}
                    </div>
                </div>

                <div class="profile-divider"></div>

                <div class="profile-info">
                    <div class="info-item">
                        <i class="bi bi-envelope"></i>
                        <span>email: {{ user.email|default:"Не указан" }}</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-calendar"></i>
                        <span>Зарегистрирован: {{ user.date_joined|date:"d.m.Y" }}</span>
                    </div>
                </div>
            </div>

            <nav class="profile-nav">
                <ul>
                    <li>
                        <a href="{% url 'characters:list' %}" class="nav-link">
                            <i class="bi bi-people"></i>
                            <span>Мои персонажи</span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'characters:create' %}" class="nav-link">
                            <i class="bi bi-plus-circle"></i>
                            <span>Создать персонажа</span>
                        </a>
                    </li>
                    <li>
                        <a href="{% url 'users:password_change_form' %}" class="nav-link">
                            <i class="bi bi-key"></i>
                            <span>Сменить пароль</span>
                        </a>
                    </li>
                    <li>
                        <form method="post" action="{% url 'users:logout' %}" class="logout-form">
                            {% csrf_token %}
                            <button type="submit" class="nav-link logout-btn">
                                <i class="bi bi-box-arrow-right"></i>
                                <span>Выйти</span>
                            </button>
                        </form>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="profile-content">
            <div id="profile-main-content">
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для загрузки контента
    function loadContent(url, elementToActivate = null) {
        fetch(url + (url.includes('?') ? '&' : '?') + 'partial=true')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                document.getElementById('profile-main-content').innerHTML = html;
                
                // Если контент загружен по клику на навигацию
                if (elementToActivate) {
                    document.querySelectorAll('.profile-nav .nav-link').forEach(navLink => {
                        navLink.classList.remove('active');
                    });
                    elementToActivate.classList.add('active');
                }
                
                // Добавляем обработчики для ссылок редактирования внутри загруженного контента
                attachEditLinksHandlers();
                
                document.getElementById('profile-main-content').scrollIntoView({
                    behavior: 'smooth'
                });
            })
            .catch(error => {
                console.error('Error loading content:', error);
                window.location.href = url;
            });
    }
    
    // Обработчик для ссылок редактирования
    function handleEditLinkClick(e) {
        e.preventDefault();
        const url = this.getAttribute('href');
        loadContent(url);
    }
    
    // Привязка обработчиков к ссылкам редактирования
    function attachEditLinksHandlers() {
        document.querySelectorAll('.profile-edit-link').forEach(link => {
            // Удаляем старые обработчики
            link.removeEventListener('click', handleEditLinkClick);
            // Добавляем новые
            link.addEventListener('click', handleEditLinkClick);
        });
    }
    
    // Навигация профиля
    document.querySelectorAll('.profile-nav a[href]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.getAttribute('href');
            loadContent(url, this);
        });
    });
    
    // Инициализация
    attachEditLinksHandlers();
    
    // Автоматически загружаем первый пункт навигации при загрузке страницы
    const firstNavLink = document.querySelector('.profile-nav a[href]');
    if (firstNavLink && !window.location.hash) {
        const url = firstNavLink.getAttribute('href');
        loadContent(url, firstNavLink);
    }
});
</script>
{% endblock %}